<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .admin-card {
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .loading {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1d4ed8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .text-sm-condensed {
            font-size: 0.8rem;
        }
        .scrollable-content {
            max-height: 70vh;
            overflow-y: auto;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            animation: slide-up 0.3s ease-in-out;
        }
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        /* Custom modal for confirm/alert */
        #custom-message-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #custom-message-content {
            animation: slide-up 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 flex flex-col items-center">
    <div class="max-w-7xl w-full">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">Admin Dashboard</h1>
            <div id="messageBox" class="p-4 rounded-lg text-sm font-semibold hidden w-full md:w-auto text-center"></div>
        </header>

        <!-- Stats Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="admin-card text-center p-6">
                <p class="text-4xl font-bold text-blue-600 mb-2" id="totalHouseholds">0</p>
                <p class="text-gray-500">Total Households</p>
            </div>
            <div class="admin-card text-center p-6">
                <p class="text-4xl font-bold text-green-600 mb-2" id="totalMembers">0</p>
                <p class="text-gray-500">Total Members</p>
            </div>
            <div class="admin-card text-center p-6">
                <p class="text-4xl font-bold text-purple-600 mb-2" id="totalChildren">0</p>
                <p class="text-gray-500">Total Children</p>
            </div>
        </div>

        <!-- Search and Records Section -->
        <div class="admin-card p-6">
            <div class="flex flex-col sm:flex-row items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 sm:mb-0">Records</h2>
                <div class="flex w-full sm:w-auto">
                    <input type="text" id="searchInput" placeholder="Search by name, household, or block..."
                           class="w-full sm:w-80 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="searchBtn" class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>

            <div id="recordsContainer" class="scrollable-content">
                <p id="loadingMessage" class="text-center text-gray-500 p-8">Loading records...</p>
                <p id="noResultsMessage" class="text-center text-gray-500 p-8 hidden">No records found. Please refine your search.</p>
                <!-- Records will be dynamically inserted here -->
            </div>
        </div>

        <!-- Record Detail Modal -->
        <div id="recordModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-2xl transform scale-95 modal-content scrollable-content">
                <div class="flex justify-between items-center p-6 border-b border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Record Details</h3>
                    <div class="flex space-x-2">
                        <button id="printBtn" class="p-2 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors duration-200" title="Print Record">
                            <i class="fas fa-print text-gray-600"></i>
                        </button>
                        <button id="deleteBtn" class="p-2 bg-red-500 rounded-full hover:bg-red-600 transition-colors duration-200" title="Delete Record">
                            <i class="fas fa-trash-alt text-white"></i>
                        </button>
                        <button id="closeModalBtn" class="p-2 bg-gray-200 rounded-full hover:bg-gray-300 transition-colors duration-200" title="Close">
                            <i class="fas fa-times text-gray-600"></i>
                        </button>
                    </div>
                </div>
                <div id="modalContent" class="p-6">
                    <!-- Dynamic record content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Message Modal -->
    <div id="custom-message-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="custom-message-content" class="bg-white rounded-xl shadow-xl p-8 w-full max-w-sm text-center transform scale-95">
            <h4 id="message-title" class="text-xl font-bold mb-4"></h4>
            <p id="message-body" class="mb-6"></p>
            <div id="message-buttons" class="flex justify-center space-x-4">
                <button id="ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">OK</button>
                <button id="cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors hidden">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // NOTE: Replace this with your Google Apps Script Web App URL
            const API_URL = 'https://script.google.com/macros/s/AKfycbyAUUG8rMQaWXSTLDuKCrZZke0qTnd_PvUxHMo012KfJZYbYD0RbUL7JMICL5ZxKQfP/exec';

            // DOM Elements
            const recordsContainer = document.getElementById('recordsContainer');
            const loadingMessage = document.getElementById('loadingMessage');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const recordModal = document.getElementById('recordModal');
            const modalContent = document.getElementById('modalContent');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const printBtn = document.getElementById('printBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const messageBox = document.getElementById('messageBox');
            
            // Custom Message Modal Elements
            const customMessageModal = document.getElementById('custom-message-modal');
            const messageTitle = document.getElementById('message-title');
            const messageBody = document.getElementById('message-body');
            const okBtn = document.getElementById('ok-btn');
            const cancelBtn = document.getElementById('cancel-btn');

            let allRecords = [];
            let currentRecord = null;
            let resolvePromise;

            // --- Custom Message Modal Functionality ---
            function showCustomMessage(title, message, isConfirm = false) {
                messageTitle.textContent = title;
                messageBody.textContent = message;
                cancelBtn.classList.toggle('hidden', !isConfirm);
                customMessageModal.classList.remove('hidden');

                return new Promise(resolve => {
                    resolvePromise = resolve;
                });
            }

            okBtn.addEventListener('click', () => {
                customMessageModal.classList.add('hidden');
                resolvePromise(true);
            });

            cancelBtn.addEventListener('click', () => {
                customMessageModal.classList.add('hidden');
                resolvePromise(false);
            });

            // --- API Call Functions ---
            const fetchCounts = async () => {
                try {
                    const response = await fetch(`${API_URL}?action=getCounts`);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const counts = await response.json();
                    document.getElementById('totalHouseholds').textContent = counts.totalHouseholds || '0';
                    document.getElementById('totalMembers').textContent = counts.totalMembers || '0';
                    document.getElementById('totalChildren').textContent = counts.totalChildren || '0';
                } catch (error) {
                    showMessage('Failed to load counts.', 'bg-red-200 text-red-800');
                    console.error('Error fetching counts:', error);
                }
            };

            const fetchRecords = async (query = '') => {
                loadingMessage.classList.remove('hidden');
                noResultsMessage.classList.add('hidden');
                recordsContainer.innerHTML = '';
            
                try {
                    const url = query ? `${API_URL}?action=search&q=${encodeURIComponent(query)}` : `${API_URL}`;
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Network response was not ok');
                    const data = await response.json();
            
                    allRecords = data.households;
                    displayRecords(allRecords);
                } catch (error) {
                    showMessage('Failed to load records. Check API URL.', 'bg-red-200 text-red-800');
                    console.error('Error fetching records:', error);
                    loadingMessage.textContent = 'Failed to load records.';
                } finally {
                    loadingMessage.classList.add('hidden');
                }
            };
            

            const showMessage = (message, colorClass) => {
                messageBox.textContent = message;
                messageBox.className = `p-4 rounded-lg text-sm text-center font-semibold visible w-full md:w-auto ${colorClass}`;
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 5000);
            };

            // --- UI Rendering Functions ---
            const displayRecords = (records) => {
                recordsContainer.innerHTML = '';
                if (records.length === 0) {
                    noResultsMessage.classList.remove('hidden');
                    return;
                }
            
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-200';
                table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Household ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Block Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Street Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="recordsTableBody"></tbody>
                `;
            
                const tbody = table.querySelector('#recordsTableBody');
                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors duration-200 cursor-pointer';
                    row.setAttribute('data-household-id', record.HouseholdID);
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm-condensed font-medium text-gray-900">${record.HouseholdID}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm-condensed text-gray-500">${record.BlockName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm-condensed text-gray-500">${record.StreetName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm-condensed">
                            <button data-household-id="${record.HouseholdID}" class="view-btn text-blue-600 hover:text-blue-900 transition-colors duration-200">View</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            
                recordsContainer.appendChild(table);
            
                // Add event listeners for the "View" buttons
                document.querySelectorAll('.view-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const householdID = e.target.getAttribute('data-household-id');
                        const record = allRecords.find(r => r.HouseholdID === householdID);
                        if (record) {
                            currentRecord = record;
                            showRecordDetails(record);
                        } else {
                            showMessage('Record not found.', 'bg-red-200 text-red-800');
                        }
                    });
                });
            };

            const showRecordDetails = (record) => {
                let content = `
                    <h4 class="text-xl font-bold mb-4">Household Details</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <p><strong>Household ID:</strong> ${record.HouseholdID}</p>
                        <p><strong>Head of Household:</strong> ${record.HeadOfHousehold}</p>
                        <p><strong>Block Name:</strong> ${record.BlockName}</p>
                        <p><strong>Street Name:</strong> ${record.StreetName}</p>
                        <p><strong>House No.:</strong> ${record.HouseNo}</p>
                        <p><strong>Parish Status:</strong> ${record.ParishStatus}</p>
                        <p><strong>Contact No.:</strong> ${record.ContactNo}</p>
                        <p><strong>Number of Children:</strong> ${record.NumberOfChildren}</p>
                    </div>
                `;

                if (record.members && record.members.length > 0) {
                    content += `<h4 class="text-xl font-bold mt-6 mb-4">Members</h4>`;
                    record.members.forEach(member => {
                        content += `
                            <div class="border rounded-lg p-4 mb-4 bg-gray-50">
                                <p class="font-bold text-base mb-2">${member.FirstName} ${member.LastName}</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                                    <p><strong>Member ID:</strong> ${member.MemberID}</p>
                                    <p><strong>Date of Birth:</strong> ${member.DateOfBirth}</p>
                                    <p><strong>Relationship:</strong> ${member.RelationshipToHead}</p>
                                    <p><strong>Age:</strong> ${member.Age}</p>
                                    <p><strong>Contact No.:</strong> ${member.ContactNo}</p>
                                    <p><strong>Occupation:</strong> ${member.Occupation}</p>
                                    <p><strong>Catholic:</strong> ${member.Catholic}</p>
                                    <p><strong>Church Activities:</strong> ${member.ChurchActivities}</p>
                                    <p><strong>Sacraments:</strong></p>
                                    <ul>
                                        <li><strong>Baptism:</strong> ${member.Baptised || 'No'} ${member.BaptismDate ? `(${member.BaptismDate})` : ''}</li>
                                        <li><strong>First Communion:</strong> ${member.FirstCommunion || 'No'} ${member.FirstCommunionDate ? `(${member.FirstCommunionDate})` : ''}</li>
                                        <li><strong>Confirmation:</strong> ${member.Confirmation || 'No'} ${member.ConfirmationDate ? `(${member.ConfirmationDate})` : ''}</li>
                                    </ul>
                                </div>
                            </div>
                        `;
                    });
                }
                
                if (record.children && record.children.length > 0) {
                    content += `<h4 class="text-xl font-bold mt-6 mb-4">Children</h4>`;
                    record.children.forEach(child => {
                        content += `
                            <div class="border rounded-lg p-4 mb-4 bg-gray-50">
                                <p class="font-bold text-base mb-2">${child.FirstName} ${child.LastName}</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 text-xs">
                                    <p><strong>Child ID:</strong> ${child.ChildID}</p>
                                    <p><strong>Date of Birth:</strong> ${child.DateOfBirth}</p>
                                    <p><strong>Age:</strong> ${child.Age}</p>
                                    <p><strong>Catholic:</strong> ${child.Catholic}</p>
                                    <p><strong>Church Activities:</strong> ${child.ChurchActivities}</p>
                                    <p><strong>Sacraments:</strong></p>
                                    <ul>
                                        <li><strong>Baptism:</strong> ${child.Baptised || 'No'} ${child.BaptismDate ? `(${child.BaptismDate})` : ''}</li>
                                        <li><strong>First Communion:</strong> ${child.FirstCommunion || 'No'} ${child.FirstCommunionDate ? `(${child.FirstCommunionDate})` : ''}</li>
                                        <li><strong>Confirmation:</strong> ${child.Confirmation || 'No'} ${child.ConfirmationDate ? `(${child.ConfirmationDate})` : ''}</li>
                                    </ul>
                                </div>
                            </div>
                        `;
                    });
                }

                modalContent.innerHTML = content;
                recordModal.classList.remove('hidden');
            };

            // --- Event Listeners ---
            searchBtn.addEventListener('click', () => {
                const query = searchInput.value.trim();
                fetchRecords(query);
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });

            closeModalBtn.addEventListener('click', () => {
                recordModal.classList.add('hidden');
                currentRecord = null;
            });
            
            // Delete functionality
            deleteBtn.addEventListener('click', async () => {
                const confirmation = await showCustomMessage(
                    "Confirm Deletion",
                    "Are you sure you want to delete this record? This action cannot be undone.",
                    true
                );

                if (!confirmation || !currentRecord) {
                    return;
                }

                const payload = {
                    action: 'deleteRecord',
                    HouseholdID: currentRecord.HouseholdID
                };
                
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'application/json' }
                    });

                    showMessage('Record deleted successfully.', 'bg-green-200 text-green-800');
                    recordModal.classList.add('hidden');
                    fetchRecords(); // Refresh the list
                    fetchCounts();
                } catch (error) {
                    showMessage('An error occurred during deletion.', 'bg-red-200 text-red-800');
                    console.error('Error deleting record:', error);
                }
            });

            // Print functionality
            printBtn.addEventListener('click', () => {
                const printContent = document.getElementById('modalContent').innerHTML;
                const originalBody = document.body.innerHTML;
                document.body.innerHTML = printContent;
                window.print();
                document.body.innerHTML = originalBody;
                window.location.reload(); // Reload to restore functionality
            });

            // Initial data fetch
            fetchCounts();
            fetchRecords();
        });
    </script>
</body>
</html>
