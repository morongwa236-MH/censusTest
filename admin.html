<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .admin-card {
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .loading {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1d4ed8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .text-sm-condensed {
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 flex flex-col items-center">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-8 space-y-8">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 text-center mb-6">Admin Dashboard</h1>

        <!-- Stats Section -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
            <div class="admin-card">
                <p class="text-gray-500 font-semibold text-sm">Total Households</p>
                <p id="totalHouseholds" class="text-3xl font-bold text-blue-600 mt-2">...</p>
            </div>
            <div class="admin-card">
                <p class="text-gray-500 font-semibold text-sm">Total Members</p>
                <p id="totalMembers" class="text-3xl font-bold text-green-600 mt-2">...</p>
            </div>
            <div class="admin-card">
                <p class="text-gray-500 font-semibold text-sm">Total Children</p>
                <p id="totalChildren" class="text-3xl font-bold text-yellow-600 mt-2">...</p>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="admin-card">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Search & Records</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="searchInput" placeholder="Search by HouseholdID, Name, or Block..." class="flex-grow p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                <button id="searchBtn" class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition-colors">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            
            <!-- Message box -->
            <div id="messageBox" class="hidden mt-4 p-4 rounded-lg text-sm text-center font-semibold"></div>

            <!-- Records List -->
            <div id="recordsList" class="space-y-4">
                <div class="loading mx-auto my-8"></div>
            </div>
        </div>

        <!-- Pagination Controls -->
        <div id="paginationContainer" class="flex justify-center items-center space-x-4 mt-6">
            <button id="prevBtn" class="bg-gray-300 text-gray-700 p-2 rounded-lg hover:bg-gray-400 transition-colors disabled:opacity-50" disabled><i class="fas fa-chevron-left"></i></button>
            <span id="pageInfo" class="text-gray-700 font-bold">Page 1</span>
            <button id="nextBtn" class="bg-gray-300 text-gray-700 p-2 rounded-lg hover:bg-gray-400 transition-colors disabled:opacity-50"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- Record Details Modal -->
    <div id="recordModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white admin-card w-full max-w-4xl max-h-[90vh] overflow-y-auto relative">
            <button id="closeModalBtn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800"><i class="fas fa-times text-2xl"></i></button>
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">Record Details</h2>
            <div id="modalContent" class="space-y-6">
                <!-- Content will be injected here -->
            </div>
            <div class="flex justify-center space-x-4 mt-6">
                <button id="printBtn" class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-indigo-700 transition-colors"><i class="fas fa-print"></i> Print</button>
                <button id="deleteBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-colors"><i class="fas fa-trash-alt"></i> Delete</button>
            </div>
        </div>
    </div>

    <!-- Custom Delete Confirmation Modal -->
    <div id="deleteConfirmModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white admin-card max-w-sm text-center">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Are you sure?</h3>
            <p class="text-gray-600 mb-6">This action cannot be undone. All data related to this household will be permanently deleted.</p>
            <div class="flex justify-center space-x-4">
                <button id="confirmDeleteBtn" class="bg-red-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-700 transition-colors">Yes, Delete</button>
                <button id="cancelDeleteBtn" class="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg font-bold hover:bg-gray-400 transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // IMPORTANT: Replace this with your Google Apps Script Web App URL
            const API_URL = "https://script.google.com/macros/s/AKfycbw39xqgioYX3oN7Y2M4Uy5oqkqjpBUbn3R9vj3LM46E2Dc6_Q8w2zfl2oCd8UMkxrY0rg/exec";

            const recordsList = document.getElementById('recordsList');
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const totalHouseholdsElem = document.getElementById('totalHouseholds');
            const totalMembersElem = document.getElementById('totalMembers');
            const totalChildrenElem = document.getElementById('totalChildren');
            const recordModal = document.getElementById('recordModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const modalContent = document.getElementById('modalContent');
            const printBtn = document.getElementById('printBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const deleteConfirmModal = document.getElementById('deleteConfirmModal');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const messageBox = document.getElementById('messageBox');
            
            let currentPage = 1;
            const recordsPerPage = 10;
            let currentData = [];
            let currentRecord = null; // Store the currently viewed record

            // Displays a message to the user
            function showMessage(message, colorClass) {
                messageBox.textContent = message;
                messageBox.className = `mt-4 p-4 rounded-lg text-sm text-center font-semibold ${colorClass} visible`;
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 5000);
            }

            // Fetches counts for the dashboard cards
            async function fetchCounts() {
                try {
                    const response = await fetch(`${API_URL}?action=getCounts`);
                    const data = await response.json();
                    totalHouseholdsElem.textContent = data.totalHouseholds;
                    totalMembersElem.textContent = data.totalMembers;
                    totalChildrenElem.textContent = data.totalChildren;
                } catch (error) {
                    console.error('Error fetching counts:', error);
                    showMessage('Failed to load counts. Check the API URL.', 'bg-red-200 text-red-800');
                }
            }

            // Fetches records from the API based on a query
            async function fetchRecords(query = '') {
                recordsList.innerHTML = `<div class="loading mx-auto my-8"></div>`;
                messageBox.classList.add('hidden');
                
                try {
                    const response = await fetch(`${API_URL}?q=${encodeURIComponent(query)}`);
                    const data = await response.json();
                    currentData = data;
                    renderRecords();
                } catch (error) {
                    console.error('Error fetching records:', error);
                    recordsList.innerHTML = `<p class="text-center text-red-500">Failed to load records. Check the API URL.</p>`;
                    showMessage('Failed to load records. Check the API URL.', 'bg-red-200 text-red-800');
                }
            }

            // Renders the list of records on the page
            function renderRecords() {
                recordsList.innerHTML = '';
                const start = (currentPage - 1) * recordsPerPage;
                const end = start + recordsPerPage;
                const recordsToDisplay = currentData.slice(start, end);

                if (recordsToDisplay.length === 0) {
                    recordsList.innerHTML = `<p class="text-center text-gray-500 py-8">No records found.</p>`;
                    return;
                }

                recordsToDisplay.forEach(record => {
                    const card = document.createElement('div');
                    card.className = "admin-card hover:shadow-xl transition-shadow cursor-pointer";
                    card.innerHTML = `
                        <h3 class="text-lg font-bold text-gray-800">Household ID: ${record.household.HouseholdID}</h3>
                        <p class="text-gray-600 text-sm">Head of Household: ${record.household.HeadofHouseholdName}</p>
                        <p class="text-gray-600 text-sm">Block: ${record.household.BlockName}</p>
                        <p class="text-gray-600 text-sm">Number of Members: ${record.members.length}</p>
                        <p class="text-gray-600 text-sm">Number of Children: ${record.children.length}</p>
                    `;
                    card.addEventListener('click', () => {
                        currentRecord = record;
                        showRecordModal(record);
                    });
                    recordsList.appendChild(card);
                });

                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${Math.ceil(currentData.length / recordsPerPage) || 1}`;
                document.getElementById('prevBtn').disabled = currentPage === 1;
                document.getElementById('nextBtn').disabled = currentPage * recordsPerPage >= currentData.length;
            }

            // Shows the detailed record modal
            function showRecordModal(record) {
                let content = '';

                // Household details
                content += `
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-2">Household Details</h4>
                        <p class="text-sm-condensed"><span class="font-semibold">HouseholdID:</span> ${record.household.HouseholdID}</p>
                        <p class="text-sm-condensed"><span class="font-semibold">Head of Household:</span> ${record.household.HeadofHouseholdName}</p>
                        <p class="text-sm-condensed"><span class="font-semibold">Block:</span> ${record.household.BlockName}</p>
                        <p class="text-sm-condensed"><span class="font-semibold">Telephone:</span> ${record.household.Telephone}</p>
                        <p class="text-sm-condensed"><span class="font-semibold">Address:</span> ${record.household.Address}</p>
                        <p class="text-sm-condensed"><span class="font-semibold">Address Line 2:</span> ${record.household.AddressLine2}</p>
                        <p class="text-sm-condensed"><span class="font-semibold">Date Submitted:</span> ${record.household.DateSubmitted}</p>
                    </div>
                `;

                // Members details
                if (record.members && record.members.length > 0) {
                    content += `<div class="bg-gray-100 p-4 rounded-lg">`;
                    content += `<h4 class="font-bold text-lg mb-2">Members</h4>`;
                    record.members.forEach(member => {
                        content += `
                            <div class="mb-4 p-3 border border-gray-200 rounded-lg">
                                <p class="text-sm-condensed"><span class="font-semibold">MemberID:</span> ${member.MemberID}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Full Name:</span> ${member.firstName} ${member.lastName}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Relationship:</span> ${member.relationship}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Date of Birth:</span> ${member.dateOfBirth}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Age:</span> ${member.age}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Catholic:</span> ${member.catholic}</p>
                            </div>
                        `;
                    });
                    content += `</div>`;
                }

                // Children details
                if (record.children && record.children.length > 0) {
                    content += `<div class="bg-gray-100 p-4 rounded-lg">`;
                    content += `<h4 class="font-bold text-lg mb-2">Children</h4>`;
                    record.children.forEach(child => {
                        content += `
                            <div class="mb-4 p-3 border border-gray-200 rounded-lg">
                                <p class="text-sm-condensed"><span class="font-semibold">ChildID:</span> ${child.ChildID}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Full Name:</span> ${child.firstName} ${child.lastName}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Date of Birth:</span> ${child.dateOfBirth}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Age:</span> ${child.age}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Catholic:</span> ${child.catholic}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Baptised:</span> ${child.baptised}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">First Communion:</span> ${child.firstCommunion}</p>
                                <p class="text-sm-condensed"><span class="font-semibold">Confirmation:</span> ${child.confirmation}</p>
                            </div>
                        `;
                    });
                    content += `</div>`;
                }
                
                modalContent.innerHTML = content;
                recordModal.classList.remove('hidden');
            }

            // Event Listeners
            searchBtn.addEventListener('click', () => {
                fetchRecords(searchInput.value);
                currentPage = 1;
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    fetchRecords(searchInput.value);
                    currentPage = 1;
                }
            });

            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderRecords();
                }
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentPage * recordsPerPage < currentData.length) {
                    currentPage++;
                    renderRecords();
                }
            });

            closeModalBtn.addEventListener('click', () => {
                recordModal.classList.add('hidden');
                currentRecord = null;
            });

            // Show delete confirmation modal
            deleteBtn.addEventListener('click', () => {
                recordModal.classList.add('hidden');
                deleteConfirmModal.classList.remove('hidden');
            });

            // Cancel delete action
            cancelDeleteBtn.addEventListener('click', () => {
                deleteConfirmModal.classList.add('hidden');
            });

            // Confirm delete action
            confirmDeleteBtn.addEventListener('click', async () => {
                deleteConfirmModal.classList.add('hidden');

                if (!currentRecord) {
                    showMessage('No record selected for deletion.', 'bg-red-200 text-red-800');
                    return;
                }

                const payload = {
                    action: 'deleteRecord',
                    HouseholdID: currentRecord.household.HouseholdID
                };

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'application/json' }
                    });

                    // Note: Since mode is 'no-cors', response status is always 0.
                    // We can assume success if the request completes without a network error.
                    // A proper implementation would require a public API or CORS setup.

                    showMessage('Record deleted successfully. Refreshing list...', 'bg-green-200 text-green-800');
                    fetchRecords(); // Refresh the list
                    fetchCounts();
                } catch (error) {
                    showMessage('An error occurred during deletion.', 'bg-red-200 text-red-800');
                    console.error('Error deleting record:', error);
                }
            });

            // Print functionality
            printBtn.addEventListener('click', () => {
                const printContent = document.getElementById('modalContent').innerHTML;
                const originalBody = document.body.innerHTML;
                document.body.innerHTML = printContent;
                window.print();
                document.body.innerHTML = originalBody;
                window.location.reload(); // Reload to restore functionality
            });

            // Initial data fetch
            fetchCounts();
            fetchRecords();
        });
    </script>
</body>
</html>
