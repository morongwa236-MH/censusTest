<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .admin-card {
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .loading {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1d4ed8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .text-sm-condensed {
            font-size: 0.8rem;
        }
        .modal {
            display: none;
        }
        .modal.active {
            display: flex;
        }
    </style>
</head>
<body class="p-8">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Our Lady Shrine Fatima - Census Admin</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="admin-card bg-gradient-blue text-white flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold">Total Households</h2>
                    <p id="householdCount" class="text-4xl font-extrabold mt-2">...</p>
                </div>
                <i class="fas fa-home text-5xl opacity-50"></i>
            </div>
            <div class="admin-card bg-gradient-green text-white flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold">Total Members</h2>
                    <p id="memberCount" class="text-4xl font-extrabold mt-2">...</p>
                </div>
                <i class="fas fa-users text-5xl opacity-50"></i>
            </div>
            <div class="admin-card bg-gradient-purple text-white flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold">Total Children</h2>
                    <p id="childrenCount" class="text-4xl font-extrabold mt-2">...</p>
                </div>
                <i class="fas fa-child text-5xl opacity-50"></i>
            </div>
        </div>

        <div class="admin-card mb-8">
            <h2 class="text-xl font-bold mb-4">Search Records</h2>
            <div class="flex items-center space-x-4">
                <input type="text" id="searchInput" placeholder="Search by name, address, or block..." class="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button id="searchBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
        </div>
        
        <div class="admin-card">
            <h2 class="text-xl font-bold mb-4">Household Records</h2>
            <div class="w-full overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="recordsTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Household ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Block Name</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Residential Address</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="recordsBody">
                        <tr>
                            <td colspan="4" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Loading records...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div id="recordModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full justify-center items-center">
        <div class="relative p-8 bg-white w-full max-w-4xl mx-auto rounded-xl shadow-lg m-10">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Record Details</h3>
                <button onclick="document.getElementById('recordModal').classList.remove('active')" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            
            <div id="modalContent" class="space-y-6">
                </div>

            <div class="mt-8 flex justify-end space-x-4">
                <button id="printBtn" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-300">
                    <i class="fas fa-print"></i> Print
                </button>
                <button id="editBtn" class="bg-yellow-500 text-white px-4 py-2 rounded-md hover:bg-yellow-600 transition duration-300">
                    <i class="fas fa-edit"></i> Edit Record
                </button>
                <button id="deleteBtn" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition duration-300">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full justify-center items-center">
        <div class="relative p-8 bg-white w-full max-w-4xl mx-auto rounded-xl shadow-lg m-10">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold">Edit Record</h3>
                <button onclick="document.getElementById('editModal').classList.remove('active')" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <form id="editForm">
                </form>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzrL6rn0SYNS2t5vDguneHcnw-nIM9CuKxY1XInxHHxk7WWaV7OHj6mtw0jfmUBgy3TmQ/exec'; // *** REPLACE THIS WITH YOUR DEPLOYED WEB APP URL ***
        
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const recordsBody = document.getElementById('recordsBody');
            const recordModal = document.getElementById('recordModal');
            const modalContent = document.getElementById('modalContent');
            const printBtn = document.getElementById('printBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const editBtn = document.getElementById('editBtn');
            const editModal = document.getElementById('editModal');
            const editForm = document.getElementById('editForm');
            let currentHouseholdID = null;

            async function fetchCountsAndRecords(query = '') {
                // Fetch counts
                const countsResponse = await fetch(`${API_URL}?action=getCounts`);
                const countsData = await countsResponse.json();
                if (countsData.totalCounts) {
                    document.getElementById('householdCount').textContent = countsData.totalCounts.totalHouseholds;
                    document.getElementById('memberCount').textContent = countsData.totalCounts.totalMembers;
                    document.getElementById('childrenCount').textContent = countsData.totalCounts.totalChildren;
                }

                // Fetch records
                recordsBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">Loading records...</td></tr>';
                const recordsResponse = await fetch(`${API_URL}?q=${encodeURIComponent(query)}`);
                const recordsData = await recordsResponse.json();
                displayRecords(recordsData.households);
            }

            function displayRecords(households) {
                recordsBody.innerHTML = '';
                if (households.length === 0) {
                    recordsBody.innerHTML = '<tr><td colspan="4" class="px-6 py-4 whitespace-nowrap text-center text-gray-500">No records found.</td></tr>';
                    return;
                }

                households.forEach(household => {
                    const row = document.createElement('tr');
                    row.className = 'cursor-pointer hover:bg-gray-100 transition duration-150';
                    row.dataset.id = household.HouseholdID;
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm-condensed text-gray-900">${household.HouseholdID}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm-condensed text-gray-900">${household.BlockName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm-condensed text-gray-900">${household.ResidentialAddress}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm-condensed font-medium">
                            <button class="view-btn text-blue-600 hover:text-blue-900 transition duration-300" data-id="${household.HouseholdID}">View</button>
                        </td>
                    `;
                    recordsBody.appendChild(row);
                });

                document.querySelectorAll('.view-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const householdID = e.target.dataset.id;
                        currentHouseholdID = householdID;
                        showRecordDetails(householdID);
                    });
                });
            }

            async function showRecordDetails(householdID) {
                modalContent.innerHTML = 'Loading...';
                const response = await fetch(`${API_URL}?action=getRecord&householdID=${householdID}`);
                const data = await response.json();
                
                if (data.household) {
                    let content = `
                        <h4 class="text-lg font-bold">Household Information</h4>
                        <table class="min-w-full divide-y divide-gray-200">
                            <tbody>
                                <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Household ID:</td><td class="px-4 py-2">${data.household.HouseholdID}</td></tr>
                                <tr><td class="px-4 py-2 font-semibold">Block Name:</td><td class="px-4 py-2">${data.household.BlockName}</td></tr>
                                <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Residential Address:</td><td class="px-4 py-2">${data.household.ResidentialAddress}</td></tr>
                                <tr><td class="px-4 py-2 font-semibold">Contact Information:</td><td class="px-4 py-2">${data.household.ContactInformation}</td></tr>
                                <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Submission Timestamp:</td><td class="px-4 py-2">${data.household.SubmissionTimestamp}</td></tr>
                            </tbody>
                        </table>
                    `;

                    if (data.members && data.members.length > 0) {
                        data.members.forEach((member, index) => {
                            content += `
                                <h4 class="text-lg font-bold mt-6">Member #${index + 1}</h4>
                                <table class="min-w-full divide-y divide-gray-200">
                                    <tbody>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Member ID:</td><td class="px-4 py-2">${member.MemberID}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">First Name:</td><td class="px-4 py-2">${member.FirstName}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Last Name:</td><td class="px-4 py-2">${member.LastName}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Date of Birth:</td><td class="px-4 py-2">${member.DateOfBirth}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Catholic:</td><td class="px-4 py-2">${member.Catholic}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Occupation:</td><td class="px-4 py-2">${member.Occupation}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Church Activities:</td><td class="px-4 py-2">${member.ChurchActivities}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Solidarity Ministry:</td><td class="px-4 py-2">${member.SolidarityMinistry}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Leadership:</td><td class="px-4 py-2">${member.Leadership}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Baptised:</td><td class="px-4 py-2">${member.Baptised}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Baptism Date:</td><td class="px-4 py-2">${member.BaptismDate}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Baptism Registration No:</td><td class="px-4 py-2">${member.BaptismRegistrationNo}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Church of Baptism:</td><td class="px-4 py-2">${member.ChurchOfBaptism}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Location of Church:</td><td class="px-4 py-2">${member.LocationOfChurch}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">First Communion:</td><td class="px-4 py-2">${member.FirstCommunion}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">First Communion Date:</td><td class="px-4 py-2">${member.FirstCommunionDate}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Church of First Communion:</td><td class="px-4 py-2">${member.ChurchOfFirstCommunion}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Confirmation:</td><td class="px-4 py-2">${member.Confirmation}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Confirmation Date:</td><td class="px-4 py-2">${member.ConfirmationDate}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Church of Confirmation:</td><td class="px-4 py-2">${member.ChurchOfConfirmation}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Marital Status:</td><td class="px-4 py-2">${member.MaritalStatus}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Civil Court Marriage Date:</td><td class="px-4 py-2">${member.CivilCourtMarriageDate}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Church Marriage Date:</td><td class="px-4 py-2">${member.ChurchMarriageDate}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Church Marriage Place:</td><td class="px-4 py-2">${member.ChurchMarriagePlace}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Divorced:</td><td class="px-4 py-2">${member.Divorced}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Dikabelo:</td><td class="px-4 py-2">${member.Dikabelo}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Date of Last Dikabelo:</td><td class="px-4 py-2">${member.DateOfLastDikabelo}</td></tr>
                                    </tbody>
                                </table>
                            `;
                        });
                    }

                    if (data.children && data.children.length > 0) {
                        data.children.forEach((child, index) => {
                            content += `
                                <h4 class="text-lg font-bold mt-6">Child #${index + 1}</h4>
                                <table class="min-w-full divide-y divide-gray-200">
                                    <tbody>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Child ID:</td><td class="px-4 py-2">${child.ChildID}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">First Name:</td><td class="px-4 py-2">${child.FirstName}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Last Name:</td><td class="px-4 py-2">${child.LastName}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Date of Birth:</td><td class="px-4 py-2">${child.DateOfBirth}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Age:</td><td class="px-4 py-2">${child.Age}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Catholic:</td><td class="px-4 py-2">${child.Catholic}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Church Activities:</td><td class="px-4 py-2">${child.ChurchActivities}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Baptised:</td><td class="px-4 py-2">${child.Baptised}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Baptism Date:</td><td class="px-4 py-2">${child.BaptismDate}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Baptism Registration No:</td><td class="px-4 py-2">${child.BaptismRegistrationNo}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Church of Baptism:</td><td class="px-4 py-2">${child.ChurchOfBaptism}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Location of Church:</td><td class="px-4 py-2">${child.LocationOfChurch}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">First Communion:</td><td class="px-4 py-2">${child.FirstCommunion}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">First Communion Date:</td><td class="px-4 py-2">${child.FirstCommunionDate}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Church of First Communion:</td><td class="px-4 py-2">${child.ChurchOfFirstCommunion}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Confirmation:</td><td class="px-4 py-2">${child.Confirmation}</td></tr>
                                        <tr class="bg-gray-50"><td class="px-4 py-2 font-semibold">Confirmation Date:</td><td class="px-4 py-2">${child.ConfirmationDate}</td></tr>
                                        <tr><td class="px-4 py-2 font-semibold">Church of Confirmation:</td><td class="px-4 py-2">${child.ChurchOfConfirmation}</td></tr>
                                    </tbody>
                                </table>
                            `;
                        });
                    }

                    modalContent.innerHTML = content;
                    recordModal.classList.add('active');
                } else {
                    modalContent.innerHTML = `<p class="text-red-500">Error: ${data.error}</p>`;
                }
            }

            // Print functionality
            printBtn.addEventListener('click', () => {
                const printContent = document.getElementById('modalContent').innerHTML;
                const originalContent = document.body.innerHTML;
                document.body.innerHTML = printContent;
                window.print();
                document.body.innerHTML = originalContent;
                window.location.reload(); // Reload to restore functionality
            });

            // Delete functionality
            deleteBtn.addEventListener('click', async () => {
                if (window.confirm("Are you sure you want to delete this record? This action cannot be undone.")) {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'deleteRecord', householdID: currentHouseholdID }),
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });
                    const result = await response.json();
                    if (result.result === 'success') {
                        alert('Record deleted successfully!');
                        recordModal.classList.remove('active');
                        fetchCountsAndRecords(); // Reload dashboard
                    } else {
                        alert('Error deleting record: ' + result.error);
                    }
                }
            });

            // Edit functionality
            editBtn.addEventListener('click', async () => {
                const response = await fetch(`${API_URL}?action=getRecord&householdID=${currentHouseholdID}`);
                const data = await response.json();
                if (data.household) {
                    const indexHtmlResponse = await fetch('https://raw.githubusercontent.com/user/repo/branch/index.html'); // Replace with a hosted URL for your index.html file
                    const indexHtmlContent = await indexHtmlResponse.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(indexHtmlContent, 'text/html');
                    const formHtml = doc.getElementById('censusForm').outerHTML;
                    
                    editForm.innerHTML = formHtml;
                    
                    const editFormElement = document.getElementById('editForm');
                    
                    // Populate household data
                    editFormElement.querySelector('#householdID').value = data.household.HouseholdID;
                    editFormElement.querySelector('#blockName').value = data.household.BlockName;
                    editFormElement.querySelector('#residentialAddress').value = data.household.ResidentialAddress;
                    editFormElement.querySelector('#contactInformation').value = data.household.ContactInformation;
                    
                    // Populate members and children data
                    const membersContainer = editFormElement.querySelector('#membersContainer');
                    const childrenContainer = editFormElement.querySelector('#childrenContainer');
                    membersContainer.innerHTML = '';
                    childrenContainer.innerHTML = '';

                    data.members.forEach((member, index) => {
                        const memberFormHtml = generateMemberFormHtml(index);
                        membersContainer.insertAdjacentHTML('beforeend', memberFormHtml);
                        populateFormSection(membersContainer.lastElementChild, member);
                    });
                    
                    data.children.forEach((child, index) => {
                        const childFormHtml = generateChildFormHtml(index);
                        childrenContainer.insertAdjacentHTML('beforeend', childFormHtml);
                        populateFormSection(childrenContainer.lastElementChild, child);
                    });
                    
                    editModal.classList.add('active');
                    recordModal.classList.remove('active');
                    
                    editFormElement.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const editedData = serializeForm(editFormElement);
                        
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'editRecord', ...editedData }),
                            headers: {
                                'Content-Type': 'application/json',
                            },
                        });
                        const result = await response.json();
                        if (result.result === 'success') {
                            alert('Record updated successfully!');
                            editModal.classList.remove('active');
                            fetchCountsAndRecords(); // Reload dashboard
                        } else {
                            alert('Error updating record: ' + result.error);
                        }
                    });
                } else {
                    alert('Error fetching record for editing: ' + data.error);
                }
            });

            // Helper functions for form handling
            function generateMemberFormHtml(index) {
                // Return a template literal of the member form section from your index.html
                // This is a placeholder and should be replaced with the actual form section from your index.html
                return `<div class="member-form">...</div>`;
            }
            
            function generateChildFormHtml(index) {
                // Return a template literal of the child form section from your index.html
                // This is a placeholder and should be replaced with the actual form section from your index.html
                return `<div class="child-form">...</div>`;
            }
            
            function populateFormSection(formSection, data) {
                for (const key in data) {
                    const element = formSection.querySelector(`[name="${key}"]`);
                    if (element) {
                        element.value = data[key];
                    }
                }
            }
            
            function serializeForm(form) {
                const formData = new FormData(form);
                const data = {};
                for (const [key, value] of formData.entries()) {
                    data[key] = value;
                }
                return data;
            }

            // Event listeners
            searchBtn.addEventListener('click', () => {
                fetchCountsAndRecords(searchInput.value);
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    fetchCountsAndRecords(searchInput.value);
                }
            });

            // Initial load
            fetchCountsAndRecords();
        });
    </script>
</body>
</html>
