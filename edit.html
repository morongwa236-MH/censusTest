<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Household Record</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .form-card {
            background-color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
        }
        .loading {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #1d4ed8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .text-sm-condensed {
            font-size: 0.8rem;
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            animation: slide-up 0.3s ease-in-out;
        }
        @keyframes slide-up {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8 flex flex-col items-center">
    <div class="max-w-7xl w-full">
        <header class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">Edit Household Record</h1>
            <div id="messageBox" class="p-4 rounded-lg text-sm font-semibold hidden w-full md:w-auto text-center"></div>
        </header>

        <!-- Search Section -->
        <div class="form-card p-6 mb-8">
            <div class="flex flex-col sm:flex-row items-center justify-between mb-4">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4 sm:mb-0">Find Record</h2>
                <div class="flex w-full sm:w-auto">
                    <input type="text" id="householdIdInput" placeholder="Enter Household ID..."
                           class="w-full sm:w-80 px-4 py-2 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="searchBtn" class="ml-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                        <i class="fas fa-search"></i> Find
                    </button>
                </div>
            </div>
            <p id="loadingMessage" class="text-center text-gray-500 p-8 hidden">Loading record...</p>
        </div>

        <!-- Edit Form Section -->
        <form id="editForm" class="hidden">
            <input type="hidden" id="householdIdHidden">

            <!-- Household Details -->
            <div class="form-card p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Household Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="headOfHousehold">Head of Household</label>
                        <input class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="headOfHousehold" type="text" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="blockName">Block Name</label>
                        <input class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="blockName" type="text" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="streetName">Street Name</label>
                        <input class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="streetName" type="text" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="houseNo">House No.</label>
                        <input class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="houseNo" type="text">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="parishStatus">Parish Status</label>
                        <select class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="parishStatus" required>
                            <option value="">Select Status</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="contactNo">Contact No.</label>
                        <input class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" id="contactNo" type="tel">
                    </div>
                </div>
            </div>

            <!-- Members Section -->
            <div class="form-card p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Members</h3>
                <div id="membersContainer">
                    <!-- Dynamic member forms will be inserted here -->
                </div>
                <button type="button" id="addMemberBtn" class="mt-4 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200">
                    Add Member
                </button>
            </div>

            <!-- Children Section -->
            <div class="form-card p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-700 mb-4">Children (below 12)</h3>
                <div id="childrenContainer">
                    <!-- Dynamic child forms will be inserted here -->
                </div>
                <button type="button" id="addChildBtn" class="mt-4 px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors duration-200">
                    Add Child
                </button>
            </div>

            <button type="submit" class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors duration-200">
                Save Changes
            </button>
        </form>
    </div>

    <!-- Custom Message Modal -->
    <div id="custom-message-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
        <div id="custom-message-content" class="bg-white rounded-xl shadow-xl p-8 w-full max-w-sm text-center transform scale-95">
            <h4 id="message-title" class="text-xl font-bold mb-4"></h4>
            <p id="message-body" class="mb-6"></p>
            <div id="message-buttons" class="flex justify-center space-x-4">
                <button id="ok-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">OK</button>
                <button id="cancel-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors hidden">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // NOTE: Replace this with your Google Apps Script Web App URL
            const API_URL = 'https://script.google.com/macros/s/AKfycbyAUUG8rMQaWXSTLDuKCrZZke0qTnd_PvUxHMo012KfJZYbYD0RbUL7JMICL5ZxKQfP/exec';

            // DOM Elements
            const householdIdInput = document.getElementById('householdIdInput');
            const searchBtn = document.getElementById('searchBtn');
            const loadingMessage = document.getElementById('loadingMessage');
            const editForm = document.getElementById('editForm');
            const householdIdHidden = document.getElementById('householdIdHidden');
            const membersContainer = document.getElementById('membersContainer');
            const childrenContainer = document.getElementById('childrenContainer');
            const addMemberBtn = document.getElementById('addMemberBtn');
            const addChildBtn = document.getElementById('addChildBtn');
            const messageBox = document.getElementById('messageBox');

            // Custom Message Modal Elements
            const customMessageModal = document.getElementById('custom-message-modal');
            const messageTitle = document.getElementById('message-title');
            const messageBody = document.getElementById('message-body');
            const okBtn = document.getElementById('ok-btn');
            const cancelBtn = document.getElementById('cancel-btn');

            let memberCount = 0;
            let childCount = 0;
            let resolvePromise;

            // --- Custom Message Modal Functionality ---
            function showCustomMessage(title, message, isConfirm = false) {
                messageTitle.textContent = title;
                messageBody.textContent = message;
                cancelBtn.classList.toggle('hidden', !isConfirm);
                customMessageModal.classList.remove('hidden');

                return new Promise(resolve => {
                    resolvePromise = resolve;
                });
            }

            okBtn.addEventListener('click', () => {
                customMessageModal.classList.add('hidden');
                resolvePromise(true);
            });

            cancelBtn.addEventListener('click', () => {
                customMessageModal.classList.add('hidden');
                resolvePromise(false);
            });

            // --- UI Rendering Functions ---
            const showMessage = (message, colorClass) => {
                messageBox.textContent = message;
                messageBox.className = `p-4 rounded-lg text-sm text-center font-semibold visible w-full md:w-auto ${colorClass}`;
                messageBox.classList.remove('hidden');
                setTimeout(() => {
                    messageBox.classList.add('hidden');
                }, 5000);
            };

            const populateForm = (record) => {
                document.getElementById('editForm').classList.remove('hidden');

                // Populate household data
                householdIdHidden.value = record.HouseholdID;
                document.getElementById('headOfHousehold').value = record.HeadOfHousehold || '';
                document.getElementById('blockName').value = record.BlockName || '';
                document.getElementById('streetName').value = record.StreetName || '';
                document.getElementById('houseNo').value = record.HouseNo || '';
                document.getElementById('parishStatus').value = record.ParishStatus || '';
                document.getElementById('contactNo').value = record.ContactNo || '';

                // Clear existing dynamic forms
                membersContainer.innerHTML = '';
                childrenContainer.innerHTML = '';
                memberCount = 0;
                childCount = 0;

                // Populate member data
                if (record.members && Array.isArray(record.members)) {
                    record.members.forEach(member => addMemberForm(member));
                }

                // Populate children data
                if (record.children && Array.isArray(record.children)) {
                    record.children.forEach(child => addChildForm(child));
                }
            };
            
            // Function to add a new member form
            const addMemberForm = (member = {}) => {
                memberCount++;
                const memberDiv = document.createElement('div');
                memberDiv.classList.add('card', 'p-4', 'mb-4', 'rounded-lg');
                memberDiv.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Member ${memberCount}</h4>
                    <input type="hidden" name="memberId" value="${member.MemberID || ''}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="block">
                            <span class="text-gray-700 text-sm">First Name</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="text" name="firstName" value="${member.FirstName || ''}" required>
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Last Name</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="text" name="lastName" value="${member.LastName || ''}" required>
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Date of Birth</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="date" name="dateOfBirth" value="${member.DateOfBirth || ''}">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Relationship to Head</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="text" name="relationship" value="${member.RelationshipToHead || ''}">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Occupation</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="text" name="occupation" value="${member.Occupation || ''}">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Contact No.</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="tel" name="contactNo" value="${member.ContactNo || ''}">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Catholic</span>
                            <select class="form-select w-full mt-1 px-3 py-2 border rounded-lg" name="catholic" required>
                                <option value="Yes" ${member.Catholic === 'Yes' ? 'selected' : ''}>Yes</option>
                                <option value="No" ${member.Catholic === 'No' ? 'selected' : ''}>No</option>
                            </select>
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Church Activities</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="text" name="churchActivities" value="${member.ChurchActivities || ''}">
                        </label>
                    </div>
                    <div class="mt-4 flex flex-col md:flex-row md:space-x-4">
                        <div class="flex-1">
                            <span class="text-gray-700 text-sm font-semibold">Baptism</span>
                            <div class="mt-1 grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="baptised" value="Yes" ${member.Baptised === 'Yes' ? 'checked' : ''}>
                                    <span class="text-sm">Baptised</span>
                                </label>
                                <input class="form-input w-full px-3 py-2 border rounded-lg text-xs" type="date" name="baptismDate" value="${member.BaptismDate || ''}">
                            </div>
                        </div>
                        <div class="flex-1">
                            <span class="text-gray-700 text-sm font-semibold">First Communion</span>
                            <div class="mt-1 grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="firstCommunion" value="Yes" ${member.FirstCommunion === 'Yes' ? 'checked' : ''}>
                                    <span class="text-sm">Received</span>
                                </label>
                                <input class="form-input w-full px-3 py-2 border rounded-lg text-xs" type="date" name="firstCommunionDate" value="${member.FirstCommunionDate || ''}">
                            </div>
                        </div>
                        <div class="flex-1">
                            <span class="text-gray-700 text-sm font-semibold">Confirmation</span>
                            <div class="mt-1 grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="confirmation" value="Yes" ${member.Confirmation === 'Yes' ? 'checked' : ''}>
                                    <span class="text-sm">Received</span>
                                </label>
                                <input class="form-input w-full px-3 py-2 border rounded-lg text-xs" type="date" name="confirmationDate" value="${member.ConfirmationDate || ''}">
                            </div>
                        </div>
                    </div>
                    ${member.MemberID ? `<button type="button" class="mt-4 px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors delete-btn" data-id="${member.MemberID}" data-type="member">Remove</button>` : ''}
                `;
                membersContainer.appendChild(memberDiv);
            };

            // Function to add a new child form
            const addChildForm = (child = {}) => {
                childCount++;
                const childDiv = document.createElement('div');
                childDiv.classList.add('card', 'p-4', 'mb-4', 'rounded-lg');
                childDiv.innerHTML = `
                    <h4 class="text-lg font-semibold text-gray-800 mb-2">Child ${childCount}</h4>
                    <input type="hidden" name="childId" value="${child.ChildID || ''}">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <label class="block">
                            <span class="text-gray-700 text-sm">First Name</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="text" name="firstName" value="${child.FirstName || ''}" required>
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Last Name</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="text" name="lastName" value="${child.LastName || ''}" required>
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Date of Birth</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="date" name="dateOfBirth" value="${child.DateOfBirth || ''}">
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Catholic</span>
                            <select class="form-select w-full mt-1 px-3 py-2 border rounded-lg" name="catholic" required>
                                <option value="Yes" ${child.Catholic === 'Yes' ? 'selected' : ''}>Yes</option>
                                <option value="No" ${child.Catholic === 'No' ? 'selected' : ''}>No</option>
                            </select>
                        </label>
                        <label class="block">
                            <span class="text-gray-700 text-sm">Church Activities</span>
                            <input class="form-input w-full mt-1 px-3 py-2 border rounded-lg" type="text" name="churchActivities" value="${child.ChurchActivities || ''}">
                        </label>
                    </div>
                    <div class="mt-4 flex flex-col md:flex-row md:space-x-4">
                        <div class="flex-1">
                            <span class="text-gray-700 text-sm font-semibold">Baptism</span>
                            <div class="mt-1 grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="baptised" value="Yes" ${child.Baptised === 'Yes' ? 'checked' : ''}>
                                    <span class="text-sm">Baptised</span>
                                </label>
                                <input class="form-input w-full px-3 py-2 border rounded-lg text-xs" type="date" name="baptismDate" value="${child.BaptismDate || ''}">
                            </div>
                        </div>
                        <div class="flex-1">
                            <span class="text-gray-700 text-sm font-semibold">First Communion</span>
                            <div class="mt-1 grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="firstCommunion" value="Yes" ${child.FirstCommunion === 'Yes' ? 'checked' : ''}>
                                    <span class="text-sm">Received</span>
                                </label>
                                <input class="form-input w-full px-3 py-2 border rounded-lg text-xs" type="date" name="firstCommunionDate" value="${child.FirstCommunionDate || ''}">
                            </div>
                        </div>
                        <div class="flex-1">
                            <span class="text-gray-700 text-sm font-semibold">Confirmation</span>
                            <div class="mt-1 grid grid-cols-2 gap-2">
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" name="confirmation" value="Yes" ${child.Confirmation === 'Yes' ? 'checked' : ''}>
                                    <span class="text-sm">Received</span>
                                </label>
                                <input class="form-input w-full px-3 py-2 border rounded-lg text-xs" type="date" name="confirmationDate" value="${child.ConfirmationDate || ''}">
                            </div>
                        </div>
                    </div>
                    ${child.ChildID ? `<button type="button" class="mt-4 px-3 py-1 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors delete-btn" data-id="${child.ChildID}" data-type="child">Remove</button>` : ''}
                `;
                childrenContainer.appendChild(childDiv);
            };

            const getFormData = () => {
                const household = {
                    HouseholdID: householdIdHidden.value,
                    HeadOfHousehold: document.getElementById('headOfHousehold').value,
                    BlockName: document.getElementById('blockName').value,
                    StreetName: document.getElementById('streetName').value,
                    HouseNo: document.getElementById('houseNo').value,
                    ParishStatus: document.getElementById('parishStatus').value,
                    ContactNo: document.getElementById('contactNo').value
                };

                const members = Array.from(membersContainer.children).map(memberDiv => ({
                    MemberID: memberDiv.querySelector('[name="memberId"]').value,
                    FirstName: memberDiv.querySelector('[name="firstName"]').value,
                    LastName: memberDiv.querySelector('[name="lastName"]').value,
                    DateOfBirth: memberDiv.querySelector('[name="dateOfBirth"]').value,
                    RelationshipToHead: memberDiv.querySelector('[name="relationship"]').value,
                    Occupation: memberDiv.querySelector('[name="occupation"]').value,
                    ContactNo: memberDiv.querySelector('[name="contactNo"]').value,
                    Catholic: memberDiv.querySelector('[name="catholic"]').value,
                    ChurchActivities: memberDiv.querySelector('[name="churchActivities"]').value,
                    Baptised: memberDiv.querySelector('[name="baptised"]').checked ? 'Yes' : 'No',
                    BaptismDate: memberDiv.querySelector('[name="baptismDate"]').value,
                    FirstCommunion: memberDiv.querySelector('[name="firstCommunion"]').checked ? 'Yes' : 'No',
                    FirstCommunionDate: memberDiv.querySelector('[name="firstCommunionDate"]').value,
                    Confirmation: memberDiv.querySelector('[name="confirmation"]').checked ? 'Yes' : 'No',
                    ConfirmationDate: memberDiv.querySelector('[name="confirmationDate"]').value,
                }));

                const children = Array.from(childrenContainer.children).map(childDiv => ({
                    ChildID: childDiv.querySelector('[name="childId"]').value,
                    FirstName: childDiv.querySelector('[name="firstName"]').value,
                    LastName: childDiv.querySelector('[name="lastName"]').value,
                    DateOfBirth: childDiv.querySelector('[name="dateOfBirth"]').value,
                    Catholic: childDiv.querySelector('[name="catholic"]').value,
                    ChurchActivities: childDiv.querySelector('[name="churchActivities"]').value,
                    Baptised: childDiv.querySelector('[name="baptised"]').checked ? 'Yes' : 'No',
                    BaptismDate: childDiv.querySelector('[name="baptismDate"]').value,
                    FirstCommunion: childDiv.querySelector('[name="firstCommunion"]').checked ? 'Yes' : 'No',
                    FirstCommunionDate: childDiv.querySelector('[name="firstCommunionDate"]').value,
                    Confirmation: childDiv.querySelector('[name="confirmation"]').checked ? 'Yes' : 'No',
                    ConfirmationDate: childDiv.querySelector('[name="confirmationDate"]').value,
                }));

                return { household, members, children };
            };

            // --- Event Listeners ---
            searchBtn.addEventListener('click', async () => {
                const householdId = householdIdInput.value.trim();
                if (!householdId) {
                    showMessage('Please enter a Household ID.', 'bg-yellow-200 text-yellow-800');
                    return;
                }

                loadingMessage.classList.remove('hidden');
                editForm.classList.add('hidden');

                try {
                    const response = await fetch(`${API_URL}?action=getRecord&householdId=${encodeURIComponent(householdId)}`);
                    const data = await response.json();

                    if (data && data.household && data.household.HouseholdID) {
                        populateForm(data);
                        showMessage('Record found. You can now edit the details.', 'bg-green-200 text-green-800');
                    } else {
                        showMessage('Record not found. Please check the ID.', 'bg-red-200 text-red-800');
                        editForm.classList.add('hidden');
                    }
                } catch (error) {
                    showMessage('An error occurred. Please check the ID or API URL.', 'bg-red-200 text-red-800');
                    console.error('Error fetching record:', error);
                } finally {
                    loadingMessage.classList.add('hidden');
                }
            });

            document.getElementById('editForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const confirmation = await showCustomMessage(
                    "Confirm Update",
                    "Are you sure you want to save these changes?",
                    true
                );

                if (!confirmation) {
                    return;
                }

                const payload = getFormData();
                payload.action = 'updateRecord';

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify(payload),
                        headers: { 'Content-Type': 'application/json' }
                    });

                    // We can't read the response in 'no-cors' mode, so assume success
                    showMessage('Record updated successfully!', 'bg-green-200 text-green-800');
                    editForm.reset();
                    editForm.classList.add('hidden');
                    householdIdInput.value = '';
                } catch (error) {
                    showMessage('An error occurred during update.', 'bg-red-200 text-red-800');
                    console.error('Error updating record:', error);
                }
            });

            addMemberBtn.addEventListener('click', () => addMemberForm());
            addChildBtn.addEventListener('click', () => addChildForm());

            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const confirmation = await showCustomMessage(
                        "Confirm Removal",
                        "Are you sure you want to remove this entry? It will be deleted on save.",
                        true
                    );

                    if (confirmation) {
                        const divToRemove = e.target.closest('.card');
                        divToRemove.remove();
                    }
                }
            });
        });
    </script>
</body>
</html>
